# .gitlab-ci.yml

stages:
  - forecast
  - deploy

# -----------------------
# Stage 4 Forecast Job
# -----------------------
stage4_forecast:
  stage: forecast
  image: python:3.11-slim
  before_script:
    - pip install -r requirements.txt
  script:
    - python src/stage4_forecast.py
    - |
      python - <<'EOF'
      import smtplib, os
      from email.mime.text import MIMEText

      with open("out/forecast.txt", "r", encoding="utf-8") as f:
          forecast = f.read()

      # Convert plain forecast into HTML with <pre> for formatting
      html_body = f"""
      <html>
        <body style="font-family:Arial, sans-serif; color:#222;">
          <h2>ðŸ“Œ ZeroDay Zen SPY Forecast</h2>
          <pre style="font-size:14px; line-height:1.4; white-space:pre-wrap;">{forecast}</pre>
          <p style="font-size:12px; color:gray;">Sent automatically by GitLab CI Â· {os.environ["EMAIL_USER"]}</p>
        </body>
      </html>
      """

      msg = MIMEText(html_body, "html", "utf-8")
      msg["Subject"] = "ðŸ“Œ ZeroDay Zen SPY Forecast"
      msg["From"] = os.environ["EMAIL_USER"]
      msg["To"] = os.environ["EMAIL_TO"]

      server = smtplib.SMTP(os.environ["SMTP_SERVER"], int(os.environ["SMTP_PORT"]))
      server.starttls()
      server.login(os.environ["EMAIL_USER"], os.environ["EMAIL_PASS"])
      server.sendmail(os.environ["EMAIL_USER"], [os.environ["EMAIL_TO"]], msg.as_string())
      server.quit()
      EOF

  artifacts:
    paths:
      - out/forecast.json
      - out/forecast.txt
    expire_in: 7 days
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'   # run on schedule
    - when: manual                              # allow manual trigger in UI

# -----------------------
# Stage 3: Deploy (optional placeholder)
# -----------------------
deploy_prod:
  stage: deploy
  image: alpine:latest
  script:
    - echo "Deploying applicationâ€¦"
  only:
    - main
