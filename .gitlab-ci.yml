stages:
  - ingest
  - forecast
  - deploy

daily_ingestion:
  stage: ingest
  image: python:3.11-slim
  before_script:
    - pip install -r requirements.txt
  script:
    - python src/data_ingestion.py   # ✅ Proper list item
  artifacts:
    paths:
      - out/ingest.log
    expire_in: 30 days
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
    - when: manual


stage4_forecast:
  stage: forecast
  image: python:3.11-slim
  before_script:
    - pip install -r requirements.txt
  script:
    - python src/stage4_forecast.py
    - python src/send_email.py
    - python src/log_time.py --hours 0.25 --notes "CI job ran: stage4_forecast"
  artifacts:
    paths:
      - out/forecast.json
      - out/forecast.txt
      - project_time_log.md
    expire_in: 30 days
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: always
    - when: manual

deploy_prod:
  stage: deploy
  image: alpine:latest
  script:
    - echo "Deploying application…"
    - python src/log_time.py --hours 0.1 --notes "CI job ran: deploy_prod"
  artifacts:
    paths:
      - project_time_log.md
    expire_in: 30 days
  only:
    - main


