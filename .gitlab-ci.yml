stages: [exec, audit]

exec_stage:
  stage: exec
  image: python:3.11
  script:
    - python --version
    - pip install -r vscode_snowflake_starter/requirements.txt
    - echo "=== EXEC STAGE STARTING ==="
    - python vscode_snowflake_starter/src/exec_audit_summary.py
    - echo "EXEC_READY=true" > exec.env
    - echo "=== EXEC STAGE COMPLETE ==="
  artifacts:
    when: always
    expire_in: 7 days
    paths:
      - "vscode_snowflake_starter/audit_exports/stage1_exec_*/REPORT_EXEC.md"
      - "vscode_snowflake_starter/audit_exports/stage1_exec_*/summary.csv"
    reports:
      dotenv: exec.env

audit_stage:
  stage: audit
  needs:
    - job: exec_stage
      artifacts: true
  script:
    - test -f exec.env || (echo "Missing exec.env from exec_stage" && exit 1)
    - source exec.env
    # run your validator here, example:
    - python vscode_snowflake_starter/src/audit_validate.py
