# GitLab CI configuration for Zen Market AI
# Runs daily forecast, emails results, and provides artifacts

stages:
  - forecast
  - deploy

# -----------------------
# Stage 4 + Email Combined
# -----------------------
stage4_forecast_and_email:
  stage: forecast
  image: python:3.11-slim
  variables:
    PYTHONPATH: "${CI_PROJECT_DIR}"
  before_script:
    - pip install -r requirements.txt
  script:
    # ✅ Sanity check: verify package import works
    - python -c "import src.zen_rules; print('✅ zen_rules import works')"

    # Run forecast generator → produces out/forecast.json
    - python src/stage4_forecast.py

    # Sanity check JSON exists
    - test -f out/forecast.json || (echo '❌ forecast.json missing' && exit 1)

    # Run email sender → consumes forecast.json
    - python src/send_email.py
  artifacts:
    paths:
      - out/forecast.json
      - out/forecast.txt
    expire_in: 7 days
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
    - when: manual

# -----------------------
# Stage 5: Deployment placeholder
# -----------------------
deploy_prod:
  stage: deploy
  image: alpine:latest
  script:
    - echo "Deploying application…"
  only:
    - main
