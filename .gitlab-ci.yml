image: python:3.11

variables:
  PIP_DISABLE_PIP_VERSION_CHECK: "1"
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  PYTHONPATH: "$CI_PROJECT_DIR/vscode_snowflake_starter/src"

cache:
  key: "${CI_JOB_IMAGE}"
  paths:
    - .cache/pip

before_script:
  - python --version
  - pip install --upgrade pip
  - pip install -r vscode_snowflake_starter/requirements.txt

stages:
  - exec
  - reports

audit_cli:
  stage: exec
  script:
    - python -c "import snowflake; print('snowflake import OK')"
    - python vscode_snowflake_starter/src/exec_audit_summary.py
    - echo "EXEC_READY=true" > exec.env
    - echo "=== DEBUG FILES ==="
    - find . -name "*.md" -o -name "*.csv"
  artifacts:
    when: always
    paths:
      - vscode_snowflake_starter/audit_exports/stage1_exec_*/REPORT_EXEC.md
      - vscode_snowflake_starter/audit_exports/stage1_exec_*/summary.csv
      - exec.env
    reports:
      dotenv: exec.env
    expire_in: 1 week
  rules:
    - when: manual

publish_exec_report:
  stage: reports
  needs:
    - job: audit_cli
      artifacts: true
  script:
    - echo "EXEC_READY=$EXEC_READY"
    - test "$EXEC_READY" = "true"
    - echo "Publishing exec report"
    - ls -la vscode_snowflake_starter/audit_exports/stage1_exec_*/
  artifacts:
    when: always
    paths:
      - vscode_snowflake_starter/audit_exports/stage1_exec_*/REPORT_EXEC.md
    expire_in: 1 week
  rules:
    - when: manual