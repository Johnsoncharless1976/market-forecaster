# File: .gitlab-ci.yml
# Title: Stage 1 CI Audit — Exec report + fail on violations
# Commit Notes:
# - Add audit stage that runs exec_audit_summary.py and ci_guard_stage1.py
# - Publishes REPORT_EXEC.md and summary.csv as build artifacts
# - Uses masked GitLab CI variables for Snowflake (no secrets in code)
# - Triggers on main and Merge Request pipelines

image: python:3.11

stages: [exec, audit]

variables:
  PIP_DISABLE_PIP_VERSION_CHECK: "1"
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  PYTHONUNBUFFERED: "1"
  # Set these in GitLab ➜ Settings ➜ CI/CD ➜ Variables (masked+protected):
  # SNOWFLAKE_ACCOUNT
  # SNOWFLAKE_USER
  # SNOWFLAKE_PASSWORD
  # SNOWFLAKE_ROLE
  # SNOWFLAKE_WAREHOUSE
  # SNOWFLAKE_DATABASE
  # SNOWFLAKE_SCHEMA
  # (optional) SNOWFLAKE_STMT_TIMEOUT, SNOWFLAKE_QUERY_TAG, JOB

<<<<<<< HEAD
# =========================
# Stage 8 QA Guardrails (prevent repeat issues)
# =========================

# CI Lint Preflight (runs first to prevent YAML/schema breaks)
ci_lint_preflight:
  stage: qa-guardrails
  image: python:3.11-slim
  before_script: []
  script:
    - chmod +x ci/ci_lint_preflight.sh
    - ./ci/ci_lint_preflight.sh
  artifacts:
    paths:
      - audit_exports/daily/
    expire_in: 1 week
  allow_failure: false

# MR-QA-1: Repo Sentinel (fail fast if not canonical)
repo_sentinel:
  stage: qa-guardrails
  image: alpine:latest
  needs: ["ci_lint_preflight"]
  before_script: []
  script:
    - echo "🛡️ Repo Sentinel - Verifying canonical repository"
    - echo "CI_PROJECT_PATH=${CI_PROJECT_PATH}"
    - echo "CI_PROJECT_ID=${CI_PROJECT_ID}"
    - |
      if [ "$CI_PROJECT_PATH" != "zenmarketai/market-forecaster" ]; then
        echo "❌ ERROR: Not canonical repo — aborting."
        echo "Expected: zenmarketai/market-forecaster"
        echo "Actual: ${CI_PROJECT_PATH}"
        exit 1
      fi
    - |
      if [ -n "$CANONICAL_PROJECT_ID" ] && [ "$CI_PROJECT_ID" != "$CANONICAL_PROJECT_ID" ]; then
        echo "❌ ERROR: Project ID mismatch — aborting."
        echo "Expected: ${CANONICAL_PROJECT_ID}"
        echo "Actual: ${CI_PROJECT_ID}"
        exit 1
      fi
    - echo "✅ Canonical repository verified"
  allow_failure: false

# MR-QA-2: Mirror & Runner Health
mirror_and_runner_health:
  stage: qa-guardrails
  image: alpine:latest
  needs: ["repo_sentinel"]
  before_script:
    - apk add --no-cache curl jq bc
  script:
    - echo "🔍 Checking mirror and runner health"
    - export AUDIT_DIR="audit_exports/daily/$(date +%Y%m%d_%H%M%S)"
    - mkdir -p ${AUDIT_DIR}
    - chmod +x ci/kneeboard_slo_tracker.sh
    - ./ci/kneeboard_slo_tracker.sh
    - |
      cat > ${AUDIT_DIR}/REPO_HEALTH.md << EOF
      # Repository Health Check
      **Date**: $(date '+%Y-%m-%d %H:%M:%S UTC')
      **Repository**: ${CI_PROJECT_PATH}
      **Pipeline**: ${CI_PIPELINE_ID}
      
      ## Health Status
      - **Project Path**: ${CI_PROJECT_PATH}
      - **Project ID**: ${CI_PROJECT_ID}
      - **Default Branch**: ${CI_DEFAULT_BRANCH}
      - **Last Green SHA**: ${CI_COMMIT_SHORT_SHA}
      - **Last Green Time**: $(date '+%Y-%m-%d %H:%M:%S UTC')
      - **Shared Runners**: Active
      
      ## Mirror Status
      - **GitHub Mirror**: Sync status requires API check
      - **Runners Active**: Yes
      
      ---
      Generated by ZenMarket AI QA Guardrails
      EOF
    - echo "📊 Repository health check completed"
    - cat ${AUDIT_DIR}/REPO_HEALTH.md
  artifacts:
    paths:
      - audit_exports/daily/
    expire_in: 1 week
  allow_failure: false

# MR-QA-4: CI Signature Check
ci_signature:
  stage: qa-guardrails
  image: alpine:latest
  needs: ["mirror_and_runner_health"]
  before_script: []
  script:
    - chmod +x ci/ci_signature_check.sh
    - ./ci/ci_signature_check.sh
  artifacts:
    paths:
      - audit_exports/daily/
    expire_in: 1 week
  allow_failure: false

# =========================
# Stage 1: Ingestion (BROKEN)
# Commit Note: ingest_data.py missing from src/. Confirm if renamed or deprecated.
# Commit Note: Job commented out, not deleted, to preserve history.
# =========================
# ingest_data:
#   stage: ingest
#   script:
#     - python src/ingest_data.py
#   artifacts:
#     paths:
#       - artifacts/ingest/
#     expire_in: 1 week

# =========================
# Stage 1.5: Ingestion Audit
# Commit Note: Valid job – validates ingestion pipeline
# =========================
ingest_audit_loop:
  stage: ingest
  needs: ["ci_signature"]
  rules:
    - if: $STAGE_OPEN_1 == "true"
      when: on_success
    - when: never
  script:
    - echo "🔄 Stage 1 (ingest) jobs enabled - STAGE_OPEN_1=true"
    - python src/ingest_audit_loop.py
=======
stages: [audit]

cache:
  key: "$CI_JOB_IMAGE"
  paths:
    - .cache/pip

before_script:
  - python --version
  - pip install --upgrade pip
  - pip install -r vscode_snowflake_starter/requirements.txt

exec_stage1:
  stage: exec
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
  script:
    - echo "=== STAGE1:EXEC JOB STARTING ==="
    - mkdir -p audit_exports
    - python vscode_snowflake_starter/src/exec_audit_summary.py
    - echo "=== STAGE1:EXEC JOB COMPLETE ===
  artifacts:
    when: always
    expire_in: 14 days
    paths:
      - audit_exports/stage1_exec_*/REPORT_EXEC.md
      - audit_exports/stage1_exec_*/summary.csv

audit_stage1:
  stage: audit
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
  script:
    - echo "=== STAGE1:AUDIT JOB STARTING ==="
    - ls -la audit_exports/
    - python vscode_snowflake_starter/src/ci_guard_stage1.py
    - echo "=== STAGE1:AUDIT JOB COMPLETE ==="
  artifacts:
    when: always
    expire_in: 14 days
    reports:
      junit: audit_exports/stage1_exec_*/summary.csv
