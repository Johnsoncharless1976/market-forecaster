# # üìÑ File: .gitlab-ci.yml
#
# üìå Title
# Zen Council ‚Äì GitLab CI/CD Pipeline (Ingestion + Stage 3.x Forecast, Scoring, Email)
#
# üìù Commit Notes
# Commit Title: CI: declare custom stages (ingest, metrics) and add Stage 3.x jobs
# Commit Message:
# - Added `ingest` and `metrics` stages explicitly so jobs no longer fail with ‚Äústage does not exist.‚Äù
# - Keeps default GitLab stages (build, test, deploy).
# - Stage 3 jobs chained correctly: forecast ‚Üí score ‚Üí email.

stages:
  - ingest
  - metrics
  - build
  - test
  - deploy

default:
  image: python:3.11-slim
  before_script:
    - python -V
    - pip install -r requirements.txt

# Stage 1: Daily Market Data Ingestion
daily_ingestion:
  stage: ingest
  script:
    - python src/data_ingestion.py
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
    - if: '$CI_COMMIT_BRANCH == "main"'

# Stage 2.1: Derived Metrics
stage2_derived_metrics:
  stage: metrics
  needs: ["daily_ingestion"]
  script:
    - python src/ingest_derived_metrics.py
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
    - if: '$CI_COMMIT_BRANCH == "main"'

# Stage 2.2: Rolling Correlations
stage2_rolling_correlations:
  stage: metrics
  needs: ["stage2_derived_metrics"]
  script:
    - python src/ingest_correlations.py
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
    - if: '$CI_COMMIT_BRANCH == "main"'

# Stage 2.3: VIX Term Structure
stage2_vix_term_structure:
  stage: metrics
  needs: ["stage2_rolling_correlations"]
  script:
    - python src/ingest_vix_term_structure.py
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
    - if: '$CI_COMMIT_BRANCH == "main"'

# Stage 3.1: Forecast Job
stage3_forecast_job:
  stage: metrics
  needs: ["stage2_vix_term_structure"]
  script:
    - python src/ingest_forecast_job.py
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
    - if: '$CI_COMMIT_BRANCH == "main"'

# Stage 3.2: Forecast Scoring
stage3_score_job:
  stage: metrics
  needs: ["stage3_forecast_job"]
  script:
    - python src/score_forecast_job.py
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
    - if: '$CI_COMMIT_BRANCH == "main"'

# Stage 3.3: Forecast Email Delivery
stage3_email_job:
  stage: metrics
  needs: ["stage3_score_job"]
  script:
    - python src/send_forecast_email.py
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
    - if: '$CI_COMMIT_BRANCH == "main"'
