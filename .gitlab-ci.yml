image: python:3.11

stages: [test, ingest]

variables:
  PIP_DISABLE_PIP_VERSION_CHECK: "1"
  PYTHONDONTWRITEBYTECODE: "1"

before_script:
  - python -m pip install --upgrade pip
  - pip install -r requirements.txt

# Runs on push/MR (NOT on schedules)
pytest:
  stage: test
  except:
    - schedules
  script:
    - pip install pytest
    - pytest -q

# Runs ONLY when triggered by a schedule
ingest_yesterday:
  stage: ingest
  only:
    - schedules
  script:
    - python - << 'PY'
import os
print("Key present:", bool(os.getenv("POLYGON_API_KEY")))
PY
    - python src/data_ingestion.py

