# File: .gitlab-ci.yml
# Title: Stage 6 – Stabilized Pipeline
# Commit Notes:
# - Consolidated email job to use format_and_send_forecast.py.
# - Commented out legacy email jobs (send_forecast_email.py, send_email.py).
# - Preserved skeleton structure for future stages.

stages:
  - ingest
  - derive
  - forecast
  - audit
  - notify

# ------------------------------
# Stage 1 – Data Ingestion
# ------------------------------
# data_ingestion:
#   stage: ingest
#   image: python:3.11-slim
#   script:
#     - pip install snowflake-connector-python python-dotenv
#     - python src/data_ingestion.py

# ------------------------------
# Stage 2 – Derived Metrics
# ------------------------------
# ingest_derived_metrics:
#   stage: derive
#   image: python:3.11-slim
#   script:
#     - pip install snowflake-connector-python python-dotenv
#     - python src/ingest_derived_metrics.py

# ------------------------------
# Stage 3 – Forecast Job
# ------------------------------
ingest_forecast_job:
  stage: forecast
  image: python:3.11-slim
  script:
    - pip install snowflake-connector-python python-dotenv
    - python src/ingest_forecast_job.py

# ------------------------------
# Stage 4 – Audit Loop (placeholder)
# ------------------------------
# ingest_audit_loop:
#   stage: audit
#   image: python:3.11-slim
#   script:
#     - pip install snowflake-connector-python python-dotenv
#     - python src/ingest_audit_loop.py

# ------------------------------
# Stage 5/6 – Unified Forecast Email
# ------------------------------
send_forecast_email:
  stage: notify
  image: python:3.11-slim
  script:
    - pip install snowflake-connector-python python-dotenv
    - python src/format_and_send_forecast.py
  only:
    - main
  dependencies:
    - ingest_forecast_job

# ------------------------------
# Legacy Email Jobs (commented out)
# ------------------------------
# send_forecast_email_legacy:
#   stage: notify
#   script:
#     - python src/send_forecast_email.py
#
# send_email_legacy:
#   stage: notify
#   script:
#     - python src/send_email.py
