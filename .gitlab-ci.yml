# File: .gitlab-ci.yml
# Title: Stage 6 – Stabilized Pipeline with Audit Artifacts
# Commit Notes:
# - Added artifact logging for Stage 3 (forecast) and Stage 4 (audit).
# - Artifacts saved for 7 days, downloadable from CI job pages.

stages:
  - ingest
  - derive
  - forecast
  - audit
  - notify

# ------------------------------
# Stage 3 – Forecast Job
# ------------------------------
ingest_forecast_job:
  stage: forecast
  image: python:3.11-slim
  script:
    - pip install snowflake-connector-python python-dotenv
    - python src/ingest_forecast_job.py | tee forecast_log.txt
  artifacts:
    paths:
      - forecast_log.txt
    expire_in: 7 days

# ------------------------------
# Stage 4 – Audit Loop
# ------------------------------
ingest_audit_loop:
  stage: audit
  image: python:3.11-slim
  script:
    - pip install snowflake-connector-python python-dotenv
    - python src/ingest_audit_loop.py | tee audit_log.txt
  dependencies:
    - ingest_forecast_job
  artifacts:
    paths:
      - audit_log.txt
    expire_in: 7 days

# ------------------------------
# Stage 5/6 – Unified Forecast Email
# ------------------------------
send_forecast_email:
  stage: notify
  image: python:3.11-slim
  script:
    - pip install snowflake-connector-python python-dotenv requests
    - python src/format_and_send_forecast.py
  only:
    - main
  dependencies:
    - ingest_forecast_job
    - ingest_audit_loop

# ------------------------------
# Legacy Email Jobs (commented out)
# ------------------------------
# send_forecast_email_legacy:
#   stage: notify
#   script:
#     - python src/send_forecast_email.py
#
# send_email_legacy:
#   stage: notify
#   script:
#     - python src/send_email.py
