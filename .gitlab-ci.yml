# ğŸ“„ File: .gitlab-ci.yml
#
# ğŸ“Œ Title
# Zen Council â€“ GitLab CI/CD Pipeline (Daily Ingestion + Stage 2.1 Derived Metrics)
#
# ğŸ“ Commit Notes
# Commit Title: CI: add Stage 2.1 derived metrics job post-ingestion
# Commit Message:
# - Structured pipeline with two stages: `ingest` and `metrics`.
# - `daily_ingestion`: runs market data ingestion (src/data_ingestion.py).
# - `stage2_derived_metrics`: computes and inserts derived metrics (src/ingest_derived_metrics.py).
# - Dependency enforced via `needs: ["daily_ingestion"]`.
# - Both jobs restricted to scheduled pipelines on `main` branch.
# - Ensures derived metrics run immediately after ingestion, idempotent by MERGE logic.

stages:
  - ingest
  - metrics

# Stage 1: Daily Market Data Ingestion
daily_ingestion:
  stage: ingest
  image: python:3.11-slim
  script:
    - pip install -r requirements.txt
    - python src/data_ingestion.py
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
    - if: '$CI_COMMIT_BRANCH == "main"'

# Stage 2.1: Derived Metrics Calculation
stage2_derived_metrics:
  stage: metrics
  image: python:3.11-slim
  needs: ["daily_ingestion"]
  script:
    - pip install -r requirements.txt
    - python src/ingest_derived_metrics.py
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
    - if: '$CI_COMMIT_BRANCH == "main"'
