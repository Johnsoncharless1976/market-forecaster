# =========================================================
# Commit: Update GitLab CI to use requirements.txt
# - Replaced manual pip install with pip install -r requirements.txt
# - Ensures sendgrid + all dependencies are available in runner
# - Preserved all jobs (inactive ones commented out, not erased)
# - Added inline commit notes for audit trail
# =========================================================

stages:
  - ingest
  - forecast
  - audit
  - notify

# =========================
# Global Defaults
# =========================
default:
  image: python:3.11-slim
  before_script:
    # Commit Note: Using pip install -r requirements.txt instead of hard-coded packages
    - python --version
    - pip install --upgrade pip
    - pip install -r requirements.txt

# =========================
# Stage 1: Ingestion
# Commit Note: Active job – pulls raw data
# =========================
ingest_data:
  stage: ingest
  script:
    - python src/ingest_data.py
  artifacts:
    paths:
      - artifacts/ingest/
    expire_in: 1 week

# =========================
# Stage 1.5: Ingestion Audit
# Commit Note: Active job – validates data pipeline
# =========================
ingest_audit_loop:
  stage: ingest
  script:
    - python src/ingest_audit_loop.py
  artifacts:
    paths:
      - artifacts/audit/
    expire_in: 1 week

# =========================
# Stage 4: Forecast Build
# Commit Note: Active job – builds forecast but does not send
# =========================
ingest_forecast_job:
  stage: forecast
  script:
    - python src/stage4_forecast.py
  artifacts:
    paths:
      - artifacts/forecast/
    expire_in: 1 week

# =========================
# Stage 4B: Format + Send Forecast
# Commit Note: Active job – formats & emails forecast
# =========================
send_forecast_email:
  stage: notify
  script:
    - python src/format_and_send_forecast.py
  only:
    - main
  artifacts:
    paths:
      - artifacts/email/
    expire_in: 1 week

# =========================
# Stage 6: Post-Mortem Audit
# Commit Note: Inactive for now – left commented for visibility
# =========================
# post_mortem_audit:
#   stage: audit
#   script:
#     - python src/post_mortem_audit.py
#   artifacts:
#     paths:
#       - artifacts/postmortem/
#     expire_in: 1 week
