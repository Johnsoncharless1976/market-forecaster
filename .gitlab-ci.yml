# üìÑ File: .gitlab-ci.yml
#
# üìå Title
# Zen Council ‚Äì GitLab CI/CD Pipeline (Daily Ingestion + Stage 2.1 Derived Metrics + Stage 2.2 Correlations)
#
# üìù Commit Notes
# Commit Title: CI: integrate Stage 2.1 + Stage 2.2 jobs into unified pipeline
# Commit Message:
# - Defines full pipeline: `ingest` ‚Üí `metrics`.
# - `daily_ingestion`: runs market data ingestion.
# - `stage2_derived_metrics`: computes derived metrics (SPX/ES/VIX/VVIX).
#   * Hardened with preflight checks to fail fast if script missing.
# - `stage2_rolling_correlations`: computes 10D/20D/60D correlations between symbol pairs.
# - Dependencies enforced with `needs` ‚Üí metrics always follow ingestion.
# - Rules restrict execution to scheduled pipelines on `main` branch.
# - Single file structure ‚Üí one commit covers all.

stages:
  - ingest
  - metrics

# Stage 1: Daily Market Data Ingestion
daily_ingestion:
  stage: ingest
  image: python:3.11-slim
  script:
    - pip install -r requirements.txt
    - python src/data_ingestion.py
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
    - if: '$CI_COMMIT_BRANCH == "main"'

# Stage 2.1: Derived Metrics Calculation
stage2_derived_metrics:
  stage: metrics
  image: python:3.11-slim
  needs: ["daily_ingestion"]
  script:
    - python -V
    - pip install -r requirements.txt
    - echo "PWD=$(pwd)"
    - echo "Repo tree (top level):"
    - ls -la
    - echo "Repo tree (src):"
    - ls -la src || true
    - 'test -f src/ingest_derived_metrics.py || { echo "‚ùå src/ingest_derived_metrics.py not found"; exit 1; }'
    - python src/ingest_derived_metrics.py
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
    - if: '$CI_COMMIT_BRANCH == "main"'

# Stage 2.2: Rolling Correlations Calculation
stage2_rolling_correlations:
  stage: metrics
  image: python:3.11-slim
  needs: ["stage2_derived_metrics"]
  script:
    - pip install -r requirements.txt
    - 'test -f src/ingest_correlations.py || { echo "‚ùå src/ingest_correlations.py not found"; exit 1; }'
    - python src/ingest_correlations.py
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
    - if: '$CI_COMMIT_BRANCH == "main"'
