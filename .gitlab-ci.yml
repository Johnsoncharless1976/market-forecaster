# GitLab CI configuration for Zen Market AI
# Runs daily data ingestion → forecast → email → deploy

stages:
  - ingest
  - forecast
  - deploy

# -----------------------
# Stage 3: Data Ingestion
# -----------------------
stage3_ingest:
  stage: ingest
  image: python:3.11-slim
  before_script:
    - pip install -r requirements.txt
  script:
    - python src/data_ingestion.py
  artifacts:
    paths:
      - out/ingest.log
    expire_in: 7 days
  rules:
    # Run automatically on schedule
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
    # Allow manual trigger from GitLab UI
    - when: manual

# -----------------------
# Stage 4: Forecast + Email
# -----------------------
stage4_forecast:
  stage: forecast
  image: python:3.11-slim
  before_script:
    - pip install -r requirements.txt
  script:
    - python src/stage4_forecast.py
    - python -m src.send_email
  needs: ["stage3_ingest"]   # ✅ ensures fresh data first
  artifacts:
    paths:
      - out/forecast.json
      - out/forecast.txt
    expire_in: 7 days
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
    - when: manual

# -----------------------
# Stage 5: Deployment placeholder
# -----------------------
deploy_prod:
  stage: deploy
  image: alpine:latest
  script:
    - echo "Deploying application…"
  only:
    - main
