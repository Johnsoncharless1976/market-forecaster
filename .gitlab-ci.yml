# =========================================================
# Commit: Add Snowflake credential requirements for notify stage
# - Added inline reminders for SNOWFLAKE_* variables
# - Forecast recipients pulled dynamically from Snowflake table
# - Ensures send_forecast_email job runs clean in CI/CD
# =========================================================

stages:
  - ingest
  - forecast
  - audit
  - notify

# =========================
# Global Defaults
# =========================
default:
  image: python:3.11-slim
  before_script:
    # Commit Note: Install dependencies from requirements.txt for consistency
    - python --version
    - pip install --upgrade pip
    - pip install -r requirements.txt

# =========================
# Stage 1: Ingestion (BROKEN)
# Commit Note: ingest_data.py missing from src/. Confirm if renamed or deprecated.
# Commit Note: Job commented out, not deleted, to preserve history.
# =========================
# ingest_data:
#   stage: ingest
#   script:
#     - python src/ingest_data.py
#   artifacts:
#     paths:
#       - artifacts/ingest/
#     expire_in: 1 week

# =========================
# Stage 1.5: Ingestion Audit
# Commit Note: Valid job – validates ingestion pipeline
# =========================
ingest_audit_loop:
  stage: ingest
  script:
    - python src/ingest_audit_loop.py
  artifacts:
    paths:
      - artifacts/audit/
    expire_in: 1 week

# =========================
# Stage 4: Forecast Build
# Commit Note: Active job – builds forecast but does not send
# =========================
ingest_forecast_job:
  stage: forecast
  script:
    - python src/stage4_forecast.py
  artifacts:
    paths:
      - artifacts/forecast/
    expire_in: 1 week

# =========================
# Stage 4B: Format + Send Forecast
# Commit Note: Active job – formats & emails forecast
# Commit Note: Requires SENDGRID_API_KEY + Snowflake creds
# Required CI/CD variables:
#   - SENDGRID_API_KEY (masked, protected)
#   - SNOWFLAKE_USER
#   - SNOWFLAKE_PASSWORD
#   - SNOWFLAKE_ACCOUNT
#   - SNOWFLAKE_WAREHOUSE
#   - SNOWFLAKE_DATABASE
#   - SNOWFLAKE_SCHEMA
# =========================
send_forecast_email:
  stage: notify
  script:
    - python src/format_and_send_forecast.py
  only:
    - main
  artifacts:
    paths:
      - artifacts/email/
    expire_in: 1 week

# =========================
# Stage 6: Post-Mortem Audit
# Commit Note: Inactive for now – preserved and commented for toggle later
# =========================
# post_mortem_audit:
#   stage: audit
#   script:
#     - python src/post_mortem_audit.py
#   artifacts:
#     paths:
#       - artifacts/postmortem/
#     expire_in: 1 week
