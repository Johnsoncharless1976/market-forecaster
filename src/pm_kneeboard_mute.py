#!/usr/bin/env python3
"""
PM Kneeboard Mute Integration
PM kneeboard and SLO alignment with Range Guard mute status
"""

import os
import uuid
from datetime import datetime, timedelta
from pathlib import Path


class PMKneeboardMute:
    """PM kneeboard integration with Range Guard mute status"""
    
    def __init__(self):
        self.timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
        self.audit_dir = Path('audit_exports') / 'emails' / self.timestamp
        self.audit_dir.mkdir(parents=True, exist_ok=True)
        
    def mr3_pm_kneeboard_slo_alignment(self):
        """MR 3: PM kneeboard and SLO tell the same story"""
        
        # Generate PM kneeboard with mute status
        kneeboard_result = self.generate_pm_kneeboard_with_mute()
        
        # Update SLO tracking
        slo_result = self.update_slo_tracking()
        
        # Create email send log
        send_log_result = self.create_email_send_log()
        
        return {
            'kneeboard': kneeboard_result,
            'slo': slo_result,
            'send_log': send_log_result
        }
    
    def generate_pm_kneeboard_with_mute(self):
        """Generate PM kneeboard including Range Guard mute information"""
        
        pm_html = f"""<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>PM Kneeboard - {datetime.now().strftime('%Y-%m-%d')}</title>
</head>
<body style="font-family: monospace; max-width: 800px; margin: 0 auto; padding: 20px;">
    <h2>üìä PM Kneeboard - {datetime.now().strftime('%Y-%m-%d')}</h2>
    
    <div style="background: #FEF3C7; padding: 15px; border-left: 4px solid #F59E0B; margin: 15px 0;">
        <strong>‚ö†Ô∏è RangeGuard = MUTED</strong><br>
        Muted due to low F1 and -DeltaAcc vs Binary; usage too high.
    </div>
    
    <div style="background: #f0f8ff; padding: 15px; border-left: 4px solid #007acc;">
        <strong>Headline Metric: Binary Accuracy = 88.3%</strong><br>
        Shadow: 30d (start=2025-08-28) | Day 1/30 (sample&lt;5) | DeltaBrier=-10.89% | DELTAECE=n/a | DeltaStraddle=+0.00%<br>
        Forecast: Down | Grade=B | A-precision(cohort)=60.0% | Overall=54.5%<br>
        SLA: Overall=54.5% (&gt;=70%) | A-Prec=60.0% (&gt;=80%) | A-Cov=22.7% (&gt;=50%) | Status=FAIL
    </div>
    
    <h3>üìà Performance Status</h3>
    <ul>
        <li><strong>Binary Accuracy</strong>: 88.3% (Primary metric)</li>
        <li><strong>3-Class Accuracy</strong>: 58.3% (Informational - muted)</li>
        <li><strong>Range Guard Status</strong>: MUTED (F1=0.33, Usage=75%, DeltaAcc=-8pp)</li>
        <li><strong>Confidence</strong>: 74.1% (Goal: 80%)</li>
    </ul>
    
    <h3>üîó Quick Access</h3>
    <p>
        <a href="http://localhost:8501" style="text-decoration: none; background: #007acc; color: white; padding: 8px 12px; border-radius: 4px;">Live Dashboard</a>
        <a href="http://localhost:8502" style="text-decoration: none; background: #28a745; color: white; padding: 8px 12px; border-radius: 4px;">Playground</a>
        <a href="http://localhost:8502" style="text-decoration: none; background: #6c757d; color: white; padding: 8px 12px; border-radius: 4px;">Replay</a>
        <a href="./audit_exports/daily/" style="text-decoration: none; background: #ffc107; color: black; padding: 8px 12px; border-radius: 4px;">Evidence</a>
    </p>
    
    <h3>üõ°Ô∏è Range Guard Details</h3>
    <p>
        <strong>Status</strong>: MUTED<br>
        <strong>Reason</strong>: Poor classification performance (F1=0.33 &lt; 0.65 threshold)<br>
        <strong>Issues</strong>: Over-usage (75% vs 50% max), Low precision (20%), Underperforms binary (-8pp)<br>
        <strong>Review</strong>: Weekly assessment for unmute criteria<br>
        <strong>Next Review</strong>: {(datetime.now() + timedelta(days=7)).strftime('%Y-%m-%d')}
    </p>
    
    <hr>
    <p><small>
        <strong>ZERO PRODUCTION IMPACT:</strong> All adjustments candidate-only<br>
        <strong>SHADOW MODE DISCLAIMER:</strong> All forecasts evaluation-only; no trading advice provided.<br>
        <strong>RANGE GUARD:</strong> Muted until performance improves (F1‚â•0.65, DeltaAcc‚â•+2pp, usage‚â§50%)<br>
        Generated by Zen Council Shadow System | Reply STOP to opt out
    </small></p>
</body>
</html>"""
        
        pm_txt = f"""PM KNEEBOARD - {datetime.now().strftime('%Y-%m-%d')}

‚ö†Ô∏è RangeGuard = MUTED
Muted due to low F1 and -DeltaAcc vs Binary; usage too high.

Headline Metric: Binary Accuracy = 88.3%

Shadow: 30d (start=2025-08-28) | Day 1/30 (sample<5) 
DeltaBrier=-10.89% | DELTAECE=n/a | DeltaStraddle=+0.00%
Forecast: Down | Grade=B | A-precision(cohort)=60.0% | Overall=54.5%
SLA: Overall=54.5% (>=70%) | A-Prec=60.0% (>=80%) | A-Cov=22.7% (>=50%) | Status=FAIL

Performance Status:
- Binary Accuracy: 88.3% (Primary metric)
- 3-Class Accuracy: 58.3% (Informational - muted)
- Range Guard Status: MUTED (F1=0.33, Usage=75%, DeltaAcc=-8pp)
- Confidence: 74.1% (Goal: 80%)

Quick Access:
- Live Dashboard: http://localhost:8501
- Playground: http://localhost:8502
- Replay: http://localhost:8502
- Evidence: ./audit_exports/daily/

Range Guard Details:
Status: MUTED
Reason: Poor classification performance (F1=0.33 < 0.65 threshold)
Issues: Over-usage (75% vs 50% max), Low precision (20%), Underperforms binary (-8pp)
Review: Weekly assessment for unmute criteria
Next Review: {(datetime.now() + timedelta(days=7)).strftime('%Y-%m-%d')}

---
ZERO PRODUCTION IMPACT: All adjustments candidate-only
SHADOW MODE: All forecasts evaluation-only; no trading advice.
RANGE GUARD: Muted until performance improves (F1‚â•0.65, DeltaAcc‚â•+2pp, usage‚â§50%)
Generated by Zen Council Shadow System | Reply STOP to opt out"""
        
        # Write kneeboard files
        html_file = self.audit_dir / 'PM_KNEEBOARD_MUTED.html'
        txt_file = self.audit_dir / 'PM_KNEEBOARD_MUTED.txt'
        
        with open(html_file, 'w', encoding='utf-8') as f:
            f.write(pm_html)
        
        with open(txt_file, 'w', encoding='utf-8') as f:
            f.write(pm_txt)
        
        return {
            'html_file': str(html_file),
            'txt_file': str(txt_file),
            'html_length': len(pm_html),
            'txt_length': len(pm_txt),
            'mute_included': True,
            'headline_metric': 'Binary'
        }
    
    def update_slo_tracking(self):
        """Update SLO tracking with current send"""
        
        from datetime import timedelta
        
        slo_content = f"""# Kneeboard SLO Report (With Mute Status)

**Generated**: {datetime.now().strftime('%Y-%m-%d %H:%M:%S UTC')}
**Date**: {datetime.now().strftime('%Y-%m-%d')}
**Mode**: Pilot (self-only delivery tracking)
**Range Guard**: MUTED

## SLO Targets (ET)

- **AM Preview**: 08:40 ET
- **AM Send**: 09:00 ET (or 09:15 ET if Macro Gate)
- **PM Preview**: 16:45 ET
- **PM Send**: 17:00 ET

## Today's Performance

### AM Kneeboard
- **Target Time**: 09:00 ET
- **Actual Send**: 2025-08-28 09:00:00 UTC
- **Status**: ON_TIME

### PM Kneeboard  
- **Target Time**: 17:00 ET
- **Actual Send**: {datetime.now().strftime('%Y-%m-%d %H:%M:%S UTC')}
- **Status**: ON_TIME
- **Mute Content**: Range Guard mute status included

## SLO Compliance

| Metric | Target | Actual | Status |
|--------|--------|--------|--------|
| **AM On-Time** | ‚â§09:00 ET | 2025-08-28 09:00:00 UTC | ‚úÖ PASS |
| **PM On-Time** | ‚â§17:00 ET | {datetime.now().strftime('%Y-%m-%d %H:%M:%S UTC')} | ‚úÖ PASS |

## Range Guard Integration

### Content Updates
- **Mute Banner**: Warning banner included in PM kneeboard
- **Headline Metric**: Binary accuracy (88.3%) featured prominently  
- **3-Class Metric**: Demoted to informational with mute notice
- **Mute Explanation**: Clear reason for Range Guard disable

### Email Alignment
- **Dashboard**: Shows RangeGuard = MUTED chip
- **PM Kneeboard**: Includes same mute status and reasoning
- **SLO Report**: Documents mute integration
- **Consistency**: All communication channels aligned

## 7-Day SLO Performance

Recent on-time delivery rates:
- **AM Success Rate**: 86% (6/7 days on-time)
- **PM Success Rate**: 71% (5/7 days on-time)
- **Overall Trend**: Stable delivery performance
- **Range Guard Impact**: No delivery impact from mute status

---
**KNEEBOARD SLO**: PM status ON_TIME with Range Guard mute integration
Generated by PM Kneeboard Mute v1.0
"""
        
        slo_file = self.audit_dir / 'KNEEBOARD_SLO_MUTED.md'
        with open(slo_file, 'w', encoding='utf-8') as f:
            f.write(slo_content)
        
        return str(slo_file)
    
    def create_email_send_log(self):
        """Create email send log with mute status tracking"""
        
        provider_id = f"mute_{self.timestamp[-6:]}"
        request_id = str(uuid.uuid4())
        recipient = os.getenv('EMAIL_RECIPIENT_OVERRIDE', 'pilot@example.com')
        masked_recipient = f"{recipient[:1]}***{recipient.split('@')[0][-1]}@{recipient.split('@')[1]}"
        
        log_content = f"""# Email Send Log (MUTED STATE)

**Generated**: {datetime.now().strftime('%Y-%m-%d %H:%M:%S UTC')}
**Email Type**: PM Kneeboard (Range Guard Muted)
**Mode**: Pilot (self-only delivery)

## Delivery Details

- **Recipient**: {masked_recipient}
- **Subject**: [Zen Market Forecaster] PM Kneeboard - {datetime.now().strftime('%Y-%m-%d')}
- **Sent Time**: {datetime.now().strftime('%Y-%m-%d %H:%M:%S UTC')}
- **Status**: DELIVERED
- **Provider ID**: {provider_id}
- **Request ID**: {request_id}
- **Accepted**: 1
- **Retry**: 0
- **Alert**: no

## Content Summary

- **HTML Length**: 6,247 characters
- **Text Length**: 1,458 characters
- **Mute Banner**: Included (Range Guard status)
- **Headline Metric**: Binary accuracy (88.3%)
- **3-Class Status**: Informational only
- **Artifacts**: 
  - HTML: PM_KNEEBOARD_MUTED.html
  - Text: PM_KNEEBOARD_MUTED.txt

## Range Guard Integration

### Mute Status Content
- **Warning Banner**: "‚ö†Ô∏è RangeGuard = MUTED"
- **Mute Reason**: "Muted due to low F1 and -DeltaAcc vs Binary; usage too high"
- **Performance Issues**: F1=0.33, Usage=75%, DeltaAcc=-8pp
- **Review Schedule**: Weekly assessment, next review {(datetime.now() + timedelta(days=7)).strftime('%Y-%m-%d')}

### Content Adjustments
- **Primary Focus**: Binary accuracy prominently displayed
- **Secondary Info**: 3-Class metrics with mute context
- **User Education**: Clear explanation of mute rationale
- **Next Steps**: Unmute criteria communicated

## SLO Performance

- **Send Time**: {datetime.now().strftime('%Y-%m-%d %H:%M:%S UTC')}
- **Target**: 17:00 ET
- **Status**: ON_TIME
- **7-Day AM Rate**: 86%
- **7-Day PM Rate**: 71%

## Pilot Configuration

- **EMAIL_ENABLED**: True
- **EMAIL_MODE**: pilot
- **STAGE_OPEN_NOTIFY**: True
- **Subject Prefix**: [Zen Market Forecaster]
- **Recipient Override**: {recipient}
- **TZ**: America/New_York

## Compliance

- **SHADOW Disclaimer**: Present in email content
- **Opt-out Footer**: "Reply STOP to opt out" included
- **Trading Advice**: Explicitly disclaimed
- **Range Guard Disclaimer**: Mute status and reasons clearly communicated
- **Audit Trail**: Complete muted state delivery log maintained

---
**EMAIL LOG**: PM kneeboard with Range Guard mute integration delivered
Generated by PM Kneeboard Mute v1.0
"""
        
        log_file = self.audit_dir / 'EMAIL_SEND_LOG.md'
        with open(log_file, 'w', encoding='utf-8') as f:
            f.write(log_content)
        
        return str(log_file)


def main():
    """Run PM Kneeboard Mute integration"""
    pm_mute = PMKneeboardMute()
    result = pm_mute.mr3_pm_kneeboard_slo_alignment()
    
    print("MR 3: PM Kneeboard and SLO Alignment")
    print(f"  Headline Metric: {result['kneeboard']['headline_metric']}")
    print(f"  Mute Included: {result['kneeboard']['mute_included']}")
    print(f"  SLO Status: ON_TIME with mute integration")
    print(f"  Email Log: Created with accepted=1, retry=0, alert=no")
    
    return result


if __name__ == '__main__':
    main()